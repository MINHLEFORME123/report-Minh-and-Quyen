
<!DOCTYPE html>
<html>
<head>
    <link rel="icon" type="image/png" href="logo.png">
    <title>Trang Quản Trị</title>
    <link rel="stylesheet" href="admin.css">
    <style>
        .price-input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .category-input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .add-category-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .add-category-btn:hover {
            background: #45a049;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="runner-character"></div>
        <div class="loading-text">Đang tải...</div>
        <div class="loading-progress"></div>
    </div>

    <!-- Custom Notification Container -->
    <div id="notificationContainer"></div>

    <!-- Modal Dialog -->
    <div id="modalOverlay" class="modal-overlay">
        <div class="modal">
            <h3>Xác nhận hành động</h3>
            <div id="modalMessage" class="modal-message"></div>
            <div class="modal-buttons">
                <button id="modalConfirmBtn" class="modal-btn modal-btn-confirm">Đồng ý</button>
                <button id="modalCancelBtn" class="modal-btn modal-btn-cancel">Hủy</button>
            </div>
        </div>
    </div>

    <nav class="navbar">
        <div class="logo">Admin Dashboard</div>
        <ul class="nav-links">
            <li><a href="#" onclick="showTab('users')">Quản lý Users</a></li>
            <li><a href="#" onclick="showTab('products')">Sản phẩm</a></li>
            <li><a href="#" onclick="logout()">Đăng xuất</a></li>
        </ul>
    </nav>

    <main>
        <div class="container"> 
            <h1>Trang Quản Trị</h1>
            
            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-btn active" onclick="showTab('users')">Quản lý Người dùng</button>
                <button class="tab-btn" onclick="showTab('products')">Quản lý Sản phẩm</button>
            </div>

            <!-- Tab Quản lý Users -->
            <div id="users" class="tab-content active">
                <!-- Form tạo tài khoản mới với phân quyền -->
                <form id="createUserForm">
                    <h2>Tạo tài khoản người dùng mới</h2>
                    <div class="input-group">
                        <label for="newUsername">Tên đăng nhập mới:</label>
                        <input type="text" id="newUsername" required>
                    </div>
                    <div class="input-group">
                        <label for="newPassword">Mật khẩu mới:</label>
                        <input type="password" id="newPassword" required>
                    </div>
                    <div class="input-group">
                        <label for="userRole">Phân quyền:</label>
                        <select id="userRole" required>
                            <option value="">Chọn quyền</option>
                            <option value="admin">Quản trị viên (Admin)</option>
                            <option value="manager">Quản lý (Manager)</option>
                            <option value="cashier">Thu ngân (Cashier)</option>
                            <option value="customer">Khách hàng (Customer)</option>
                        </select>
                    </div>
                    <button type="submit">Tạo Tài Khoản</button>
                </form>

                <!-- Danh sách tài khoản hiện tại -->
                <div class="user-management">
                    <h2>Danh sách tài khoản</h2>
                    <div id="userList"></div>
                    <button id="refreshUsers">Làm mới danh sách</button>
                </div>
            </div>

            <!-- Tab Quản lý Sản phẩm -->
            <div id="products" class="tab-content">
                <!-- Thống kê sản phẩm -->
                <div class="stats-box">
                    <div class="stat-card">
                        <div class="stat-number" id="totalProducts">0</div>
                        <div class="stat-label">Tổng số món</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalCategories">0</div>
                        <div class="stat-label">Số loại món</div>
                    </div>
                </div>

                <!-- Form thêm sản phẩm -->
                <form id="productForm">
                    <h2>Thêm món ăn mới</h2>
                    <div class="input-group">
                        <label>Tên món ăn (Tiếng Việt):</label>
                        <input type="text" id="name-vi" required>
                    </div>
                    
                    <div class="input-group">
                        <label>Tên món ăn (Tiếng Anh):</label>
                        <input type="text" id="name-en" required>
                    </div>
                    
                    <div class="input-group">
                        <label>Tên món ăn (Tiếng Phần Lan):</label>
                        <input type="text" id="name-fi" required>
                    </div>
                    
                    <!-- Phần nhập giá tiền -->
                    <div class="input-group" id="priceGroup">
                        <label>Giá tiền:</label>
                        <div class="price-input-container">
                            <input type="number" id="price" min="0" step="0.01">
                            <select id="currency">
                                <option value="€">Euro (€)</option>
                                <option value="$">Dollar ($)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Phần nhập giá size M và L cho nước -->
                    <div class="input-group" id="drinkPriceGroup" style="display: none;">
                        <label>Giá Size M:</label>
                        <div class="price-input-container">
                            <input type="number" id="priceM" min="0" step="0.01">
                            <select id="currencyM">
                                <option value="€">Euro (€)</option>
                                <option value="$">Dollar ($)</option>
                            </select>
                        </div>

                        <label>Giá Size L:</label>
                        <div class="price-input-container">
                            <input type="number" id="priceL" min="0" step="0.01">
                            <select id="currencyL">
                                <option value="€">Euro (€)</option>
                                <option value="$">Dollar ($)</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Phần nhập giá gốc cho Lounas -->
                    <div class="input-group" id="originalPriceGroup" style="display: none;">
                        <label>Giá gốc (Chỉ cho Lounas):</label>
                        <div class="price-input-container">
                            <input type="number" id="originalPrice" min="0" step="0.01">
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label>Loại thức ăn:</label>
                        <div class="category-input-container">
                            <select id="category" required>
                                <option value="">Chọn loại</option>
                            </select>
                            <button type="button" class="add-category-btn" onclick="showAddCategoryModal()">+</button>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label>Thành phần món ăn (Tiếng Việt):</label>
                        <textarea id="ingredients-vi" rows="4" placeholder="Liệt kê các thành phần, cách nhau bằng dấu phẩy"></textarea>
                    </div>
                    
                    <div class="input-group">
                        <label>Thành phần món ăn (Tiếng Anh):</label>
                        <textarea id="ingredients-en" rows="4"></textarea>
                    </div>
                    
                    <div class="input-group">
                        <label>Thành phần món ăn (Tiếng Phần Lan):</label>
                        <textarea id="ingredients-fi" rows="4"></textarea>
                    </div>
                    
                    <div class="input-group">
                        <label>Hình ảnh món ăn:</label>
                        <input type="file" id="image" accept="image/*">
                    </div>
                    
                    <button type="submit">Thêm Món Ăn</button>
                </form>

                <!-- Tìm kiếm và lọc sản phẩm -->
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="Tìm kiếm món ăn..." onkeyup="searchProducts()">
                    <select id="category-filter" onchange="filterProducts()">
                        <option value="">Tất cả loại</option>
                    </select>
                </div>

                <!-- Danh sách sản phẩm -->
                <div class="product-management">
                    <h2>Danh sách món ăn hiện có</h2>
                    <div id="products-list" class="products-grid">
                        <!-- Sản phẩm sẽ được hiển thị ở đây -->
                    </div>
                    <button onclick="loadProducts()">Làm mới danh sách</button>
                    <button onclick="exportMenu()" style="margin-left: 10px; background: linear-gradient(45deg, #ffd700, #ff8c00);">Xuất Menu</button>
                    <button onclick="importMenu()" style="margin-left: 10px; background: linear-gradient(45deg, #00ffff, #0080ff);">Nhập Menu</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Firebase SDK -->
    <script type="module">
        // Import các hàm từ Firebase CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { 
            getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, getDoc, setDoc, query, where
        } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCh1zPuWrZ6g3UHQPJeahp--96vHoiRB-k",
            authDomain: "minhkiot-7f5d6.firebaseapp.com",
            projectId: "minhkiot-7f5d6",
            storageBucket: "minhkiot-7f5d6.firebasestorage.app",
            messagingSenderId: "25045319035",
            appId: "1:25045319035:web:30e7e5d07dc3a75c8411de",
            measurementId: "G-FZHVBC1NFG"
        };

        // Khởi tạo Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Biến để lưu API key
        let GOOGLE_TRANSLATE_API_KEY = "";

        // Hàm lấy API key từ Firestore
        async function getApiKeyFromFirestore() {
            try {
                const apiKeysRef = collection(db, "api_keys");
                const snapshot = await getDocs(apiKeysRef);
                
                if (snapshot.empty) {
                    // Nếu collection chưa tồn tại, tạo document mẫu
                    await addDoc(apiKeysRef, {
                        service: "google_translate",
                        apiKey: "YOUR_API_KEY_HERE",
                        createdAt: new Date()
                    });
                    console.log("Đã tạo collection 'api_keys' với document mẫu");
                    return "YOUR_API_KEY_HERE";
                } else {
                    // Lấy API key đầu tiên (hoặc bạn có thể tìm theo service)
                    const firstDoc = snapshot.docs[0];
                    return firstDoc.data().apiKey || "";
                }
            } catch (error) {
                console.error("Lỗi khi lấy API key từ Firestore:", error);
                return "";
            }
        }

        /**
         * Hàm gọi Google Cloud Translation API để dịch văn bản
         * @param {string} text - Văn bản cần dịch
         * @param {string} sourceLanguage - Ngôn ngữ gốc (ví dụ: 'en', 'fi')
         * @param {string} targetLanguage - Ngôn ngữ đích (mặc định 'vi')
         */
        async function translateWithGoogle(text, sourceLanguage, targetLanguage = 'vi') {
            if (!text || !text.trim()) return text;
            
            // Nếu ngôn ngữ gốc đã là tiếng Việt thì không cần dịch
            if (sourceLanguage === targetLanguage) return text;

            // Nếu chưa có API key, lấy từ Firestore
            if (!GOOGLE_TRANSLATE_API_KEY) {
                GOOGLE_TRANSLATE_API_KEY = await getApiKeyFromFirestore();
            }

            try {
                const response = await fetch(`https://translation.googleapis.com/language/translate/v2?key=${GOOGLE_TRANSLATE_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        q: text,
                        source: sourceLanguage,
                        target: targetLanguage,
                        format: 'text'
                    })
                });
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                return data.data.translations[0].translatedText;
            } catch (error) {
                console.error('Lỗi dịch thuật với Google Translate:', error);
                return `${text} (Lỗi dịch)`; // Trả về text gốc nếu lỗi
            }
        }

        // Biến toàn cục để lưu trữ menu JSON
        let menuData = [];
        let currentEditingProductId = null;
        let currentImageBase64 = null; // Lưu ảnh dưới dạng base64

        // Hiển thị loading và chuyển trang
        function showLoadingAndNavigate(url) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.remove('hidden');
            
            setTimeout(() => {
                window.location.href = url;
            }, 500);
        }

        // Đăng xuất
        function logout() {
            localStorage.removeItem('loggedInUser');
            showNotification('Đăng xuất thành công!', 'success');
            setTimeout(() => {
                showLoadingAndNavigate('index.html');
            }, 1000);
        }

        // Hiển thị tab
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
            if (tabId === 'products') {
                updateProductStats();
                displayProducts();
            }
        }

        // Hiển thị thông báo custom
        function showNotification(message, type = 'info') {
            const notificationContainer = document.getElementById('notificationContainer');
            const notificationId = 'notification_' + Date.now();
            const icons = {
                success: '✓',
                error: '✗',
                warning: '⚠',
                info: 'ℹ'
            };
            const notification = document.createElement('div');
            notification.id = notificationId;
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <span class="notification-icon">${icons[type] || 'ℹ'}</span>
                    <span class="notification-message">${message}</span>
                    <button class="notification-close" onclick="closeNotification('${notificationId}')">&times;</button>
                </div>
            `;
            notificationContainer.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 10);
            setTimeout(() => closeNotification(notificationId), 5000);
        }

        // Đóng thông báo
        function closeNotification(id) {
            const notification = document.getElementById(id);
            if (notification) {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }
        }

        // Hiển thị modal dialog
        function showModal(message, onConfirm) {
            const modalOverlay = document.getElementById('modalOverlay');
            const modalMessage = document.getElementById('modalMessage');
            const confirmBtn = document.getElementById('modalConfirmBtn');
            const cancelBtn = document.getElementById('modalCancelBtn');
            
            modalMessage.textContent = message;
            modalOverlay.classList.add('show');
            
            confirmBtn.onclick = function() {
                modalOverlay.classList.remove('show');
                if (onConfirm) onConfirm();
            };
            
            cancelBtn.onclick = function() {
                modalOverlay.classList.remove('show');
            };
            
            modalOverlay.onclick = function(e) {
                if (e.target === modalOverlay) {
                    modalOverlay.classList.remove('show');
                }
            };
        }

        // Dịch tên món ăn khi nhấn Enter
        async function translateDishNameOnEnter() {
            const nameViInput = document.getElementById('name-vi');
            const nameEnInput = document.getElementById('name-en');
            const nameFiInput = document.getElementById('name-fi');
            
            nameViInput.addEventListener('keypress', async function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const vietnameseName = this.value.trim();
                    if (vietnameseName) {
                        nameEnInput.value = 'Đang dịch...';
                        nameFiInput.value = 'Đang dịch...';
                        
                        const enTranslation = await translateWithGoogle(vietnameseName, 'vi', 'en');
                        const fiTranslation = await translateWithGoogle(vietnameseName, 'vi', 'fi');
                        
                        nameEnInput.value = enTranslation;
                        nameFiInput.value = fiTranslation;
                    }
                }
            });
        }

        // Dịch thành phần món ăn khi nhấn Enter
        async function translateIngredientsOnEnter() {
            const ingredientsViInput = document.getElementById('ingredients-vi');
            const ingredientsEnInput = document.getElementById('ingredients-en');
            const ingredientsFiInput = document.getElementById('ingredients-fi');
            
            ingredientsViInput.addEventListener('keypress', async function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const vietnameseIngredients = this.value.trim();
                    if (vietnameseIngredients) {
                        ingredientsEnInput.value = 'Đang dịch...';
                        ingredientsFiInput.value = 'Đang dịch...';
                        
                        const enTranslation = await translateWithGoogle(vietnameseIngredients, 'vi', 'en');
                        const fiTranslation = await translateWithGoogle(vietnameseIngredients, 'vi', 'fi');
                        
                        ingredientsEnInput.value = enTranslation;
                        ingredientsFiInput.value = fiTranslation;
                    }
                }
            });
        }

        // ============ CHỨC NĂNG QUẢN LÝ DANH MỤC VỚI FIREBASE ============

        // Tải danh mục từ Firestore
        async function loadCategoriesFromFirestore() {
            try {
                const querySnapshot = await getDocs(collection(db, "categories"));
                const categories = [];
                
                querySnapshot.forEach((doc) => {
                    categories.push(doc.data().name);
                });
                
                // Cập nhật dropdown danh mục
                updateCategoryDropdowns(categories);
                return categories;
            } catch (error) {
                console.error('Lỗi khi tải danh mục từ Firestore:', error);
                return [];
            }
        }

        // Cập nhật dropdown danh mục
        function updateCategoryDropdowns(categories) {
            const categorySelect = document.getElementById('category');
            const categoryFilter = document.getElementById('category-filter');
            
            // Lưu giá trị hiện tại
            const currentCategoryValue = categorySelect.value;
            const currentFilterValue = categoryFilter.value;
            
            // Xóa tất cả options trừ option đầu tiên
            categorySelect.innerHTML = '<option value="">Chọn loại</option>';
            categoryFilter.innerHTML = '<option value="">Tất cả loại</option>';
            
            // Thêm các danh mục vào dropdown
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
                
                const filterOption = document.createElement('option');
                filterOption.value = category;
                filterOption.textContent = category;
                categoryFilter.appendChild(filterOption);
            });
            
            // Khôi phục giá trị đã chọn
            categorySelect.value = currentCategoryValue;
            categoryFilter.value = currentFilterValue;
        }

        // Thêm danh mục mới vào Firestore
        async function addCategoryToFirestore(categoryName) {
            try {
                // Kiểm tra xem danh mục đã tồn tại chưa
                const q = query(collection(db, "categories"), where("name", "==", categoryName));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    await addDoc(collection(db, "categories"), {
                        name: categoryName,
                        createdAt: new Date()
                    });
                    console.log(`Đã thêm danh mục: ${categoryName}`);
                    return true;
                } else {
                    console.log(`Danh mục "${categoryName}" đã tồn tại`);
                    return false;
                }
            } catch (error) {
                console.error('Lỗi khi thêm danh mục vào Firestore:', error);
                showNotification('Lỗi khi thêm danh mục: ' + error.message, 'error');
                return false;
            }
        }

        // Hiển thị modal thêm loại thức ăn
        async function showAddCategoryModal() {
            const modalOverlay = document.getElementById('modalOverlay');
            const modalMessage = document.getElementById('modalMessage');
            const confirmBtn = document.getElementById('modalConfirmBtn');
            const cancelBtn = document.getElementById('modalCancelBtn');
            
            modalMessage.innerHTML = `
                <div class="input-group">
                    <label for="newCategory">Tên loại thức ăn mới (Tiếng Việt):</label>
                    <input type="text" id="newCategory" placeholder="Ví dụ: Món nướng" required>
                </div>
                <div class="input-group">
                    <label for="newCategoryEn">Tên tiếng Anh:</label>
                    <input type="text" id="newCategoryEn" required>
                </div>
                <div class="input-group">
                    <label for="newCategoryFi">Tên tiếng Phần Lan:</label>
                    <input type="text" id="newCategoryFi" required>
                </div>
            `;
            
            const newCategoryInput = document.getElementById('newCategory');
            const newCategoryEnInput = document.getElementById('newCategoryEn');
            const newCategoryFiInput = document.getElementById('newCategoryFi');
            
            newCategoryInput.addEventListener('keypress', async function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (this.value.trim()) {
                        newCategoryEnInput.value = 'Đang dịch...';
                        newCategoryFiInput.value = 'Đang dịch...';
                        
                        const enTranslation = await translateWithGoogle(this.value, 'vi', 'en');
                        const fiTranslation = await translateWithGoogle(this.value, 'vi', 'fi');
                        
                        newCategoryEnInput.value = enTranslation;
                        newCategoryFiInput.value = fiTranslation;
                    }
                }
            });
            
            confirmBtn.onclick = async function() {
                const newCategory = document.getElementById('newCategory').value.trim();
                
                if (newCategory) {
                    // Thêm danh mục vào Firestore
                    const added = await addCategoryToFirestore(newCategory);
                    
                    if (added) {
                        // Tải lại danh mục
                        await loadCategoriesFromFirestore();
                        
                        showNotification(`Đã thêm loại "${newCategory}" thành công!`, 'success');
                    } else {
                        showNotification(`Loại "${newCategory}" đã tồn tại!`, 'warning');
                    }
                    
                    modalOverlay.classList.remove('show');
                } else {
                    showNotification('Vui lòng nhập tên danh mục!', 'warning');
                }
            };
            
            cancelBtn.onclick = function() {
                modalOverlay.classList.remove('show');
            };
            
            modalOverlay.onclick = function(e) {
                if (e.target === modalOverlay) {
                    modalOverlay.classList.remove('show');
                }
            };
            
            modalOverlay.classList.add('show');
        }

        // ============ KẾT THÚC CHỨC NĂNG QUẢN LÝ DANH MỤC ============

        // Kiểm tra đăng nhập admin
        function checkAdminLogin() {
            const loggedInUser = localStorage.getItem('loggedInUser');
            return loggedInUser === 'admin';
        }

        // ============ CHỨC NĂNG ẨN/HIỆN Ô GIÁ SIZE M & L CHO NƯỚC ============
        const categorySelect = document.getElementById('category');
        const priceGroup = document.getElementById('priceGroup');
        const drinkPriceGroup = document.getElementById('drinkPriceGroup');
        const originalPriceGroup = document.getElementById('originalPriceGroup');
        const originalPriceInput = document.getElementById('originalPrice');

        // Hàm kiểm tra và cập nhật required fields
        function updateRequiredFields() {
            const category = categorySelect.value;
            
            // Reset tất cả required
            document.getElementById('price').removeAttribute('required');
            document.getElementById('priceM').removeAttribute('required');
            document.getElementById('priceL').removeAttribute('required');
            
            // Set required theo loại
            if (category === 'nước') {
                document.getElementById('priceM').setAttribute('required', 'required');
                document.getElementById('priceL').setAttribute('required', 'required');
            } else {
                document.getElementById('price').setAttribute('required', 'required');
            }
        }

        categorySelect.addEventListener('change', function () {
            if (this.value === 'nước') {
                priceGroup.style.display = 'none';   // Ẩn ô giá tiền đơn
                drinkPriceGroup.style.display = 'block'; // Hiện ô giá M & L
            } else {
                priceGroup.style.display = 'block';  // Hiện lại ô giá tiền đơn
                drinkPriceGroup.style.display = 'none';  // Ẩn ô giá M & L
                document.getElementById('priceM').value = '';
                document.getElementById('priceL').value = '';
                document.getElementById('currencyM').value = '€';
                document.getElementById('currencyL').value = '€';
            }

            // Xử lý hiển thị giá gốc cho Lounas
            if (this.value === 'lounas') {
                originalPriceGroup.style.display = 'block';
            } else {
                originalPriceGroup.style.display = 'none';
                originalPriceInput.value = '';
            }
            
            // Cập nhật required fields
            updateRequiredFields();
        });
        // ============ KẾT THÚC CODE ẨN/HIỆN ============

        // ============ CHỨC NĂNG CONVERT ẢNH SANG BASE64 ============

        // Xử lý chọn ảnh và convert sang base64
        document.getElementById('image').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Kiểm tra kích thước file (giới hạn 2MB)
                if (file.size > 2 * 1024 * 1024) {
                    showNotification('Ảnh quá lớn! Vui lòng chọn ảnh dưới 2MB', 'error');
                    this.value = '';
                    return;
                }
                
                // Kiểm tra loại file
                if (!file.type.startsWith('image/')) {
                    showNotification('Vui lòng chọn file ảnh!', 'error');
                    this.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    currentImageBase64 = event.target.result;
                    showNotification('Đã chọn ảnh: ' + file.name, 'success');
                };
                reader.readAsDataURL(file);
            }
        });

        // ============ CHỨC NĂNG QUẢN LÝ USERS VỚI FIREBASE ============

        // Tạo tài khoản mới với phân quyền
        document.getElementById('createUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!checkAdminLogin()) {
                showNotification('Bạn cần đăng nhập với tài khoản admin!', 'error');
                setTimeout(() => showLoadingAndNavigate('login.html'), 2000);
                return;
            }

            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.remove('hidden');

            setTimeout(async () => {
                const newUsername = document.getElementById('newUsername').value.trim();
                const newPassword = document.getElementById('newPassword').value.trim();
                const userRole = document.getElementById('userRole').value;

                if (!newUsername || !newPassword || !userRole) {
                    showNotification('Vui lòng nhập đầy đủ thông tin và chọn quyền!', 'warning');
                    loadingOverlay.classList.add('hidden');
                    return;
                }

                try {
                    // Kiểm tra xem user đã tồn tại chưa
                    const userDoc = await getDoc(doc(db, "users", newUsername));
                    
                    if (userDoc.exists()) {
                        showModal(`Tên đăng nhập "${newUsername}" đã tồn tại. Bạn có muốn cập nhật mật khẩu không?`, async function() {
                            await updateDoc(doc(db, "users", newUsername), {
                                password: newPassword,
                                role: userRole
                            });
                            await loadUsers();
                            document.getElementById('createUserForm').reset();
                            showNotification('Cập nhật mật khẩu thành công!', 'success');
                            loadingOverlay.classList.add('hidden');
                        });
                        return;
                    }

                    // Tạo user mới
                    await setDoc(doc(db, "users", newUsername), {
                        username: newUsername,
                        password: newPassword,
                        role: userRole
                    });
                    
                    await loadUsers();
                    document.getElementById('createUserForm').reset();
                    showNotification('Tạo tài khoản thành công!', 'success');
                } catch (error) {
                    console.error('Lỗi:', error);
                    showNotification('Lỗi khi tạo tài khoản: ' + error.message, 'error');
                } finally {
                    if (!document.querySelector('#modalOverlay.show')) {
                        loadingOverlay.classList.add('hidden');
                    }
                }
            }, 500);
        });

        // Xóa tài khoản
        async function deleteUser(username) {
            if (!checkAdminLogin()) {
                showNotification('Bạn cần đăng nhập với tài khoản admin!', 'error');
                setTimeout(() => showLoadingAndNavigate('login.html'), 2000);
                return;
            }

            showModal(`Bạn có chắc chắn muốn xóa tài khoản "${username}"?`, async function() {
                const loadingOverlay = document.getElementById('loadingOverlay');
                loadingOverlay.classList.remove('hidden');

                setTimeout(async () => {
                    try {
                        await deleteDoc(doc(db, "users", username));
                        await loadUsers();
                        showNotification('Xóa tài khoản thành công!', 'success');
                    } catch (error) {
                        console.error('Lỗi:', error);
                        showNotification('Lỗi khi xóa tài khoản: ' + error.message, 'error');
                    } finally {
                        loadingOverlay.classList.add('hidden');
                    }
                }, 500);
            });
        }

        // Làm mới danh sách users
        document.getElementById('refreshUsers').addEventListener('click', async function() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.remove('hidden');
            
            setTimeout(async () => {
                await loadUsers();
                showNotification('Đã làm mới danh sách tài khoản!', 'info');
                loadingOverlay.classList.add('hidden');
            }, 500);
        });

        // Đọc danh sách tài khoản từ Firebase
        async function loadUsers() {
            try {
                const querySnapshot = await getDocs(collection(db, "users"));
                const userLines = [];
                
                querySnapshot.forEach((doc) => {
                    const userData = doc.data();
                    userLines.push(`${userData.username}:${userData.password}:${userData.role}`);
                });
                
                displayUsers(userLines);
            } catch (error) {
                console.error('Lỗi khi tải danh sách users:', error);
                document.getElementById('userList').innerHTML = 
                    '<p style="color: red;">Lỗi: Không thể đọc dữ liệu người dùng</p>';
            }
        }

        // Hiển thị danh sách tài khoản với quyền
        function displayUsers(userLines) {
            let html = '<table class="user-table">';
            html += '<tr><th>Tên đăng nhập</th><th>Mật khẩu</th><th>Quyền</th><th>Thao tác</th></tr>';
            
            userLines.forEach((line, index) => {
                const [username, password, role] = line.split(':');
                if (username && password) {
                    const roleName = getRoleName(role || 'customer');
                    html += `
                        <tr>
                            <td>${username}</td>
                            <td>${password}</td>
                            <td>${roleName}</td>
                            <td>
                                ${username !== 'admin' ? 
                                    `<button onclick="deleteUser('${username}')" class="delete-btn">Xóa</button>` : 
                                    'Không thể xóa'
                                }
                            </td>
                        </tr>
                    `;
                }
            });
            
            html += '</table>';
            document.getElementById('userList').innerHTML = html;
        }

        // Hàm chuyển đổi role code thành tên hiển thị
        function getRoleName(roleCode) {
            const roles = {
                'admin': 'Quản trị viên',
                'manager': 'Quản lý',
                'cashier': 'Thu ngân',
                'customer': 'Khách hàng'
            };
            return roles[roleCode] || 'Khách hàng';
        }

        // ============ CHỨC NĂNG QUẢN LÝ SẢN PHẨM VỚI FIREBASE ============

        // Tải danh sách sản phẩm từ Firestore
        async function loadProductsFromFirestore() {
            try {
                const querySnapshot = await getDocs(collection(db, "menu"));
                menuData = [];
                
                querySnapshot.forEach((doc) => {
                    const productData = doc.data();
                    productData.id = doc.id; // Lưu ID của document
                    menuData.push(productData);
                });
                
                showNotification('Đã tải menu từ Firestore thành công!', 'success');
            } catch (error) {
                console.error('Lỗi khi tải menu từ Firestore:', error);
                showNotification('Không thể tải menu từ Firestore.', 'error');
                menuData = [];
            }
        }

        // Hiển thị danh sách sản phẩm từ menuData
        function displayProducts(productsToShow = null) {
            const products = productsToShow || menuData;
            const productsList = document.getElementById('products-list');
            
            if (products.length === 0) {
                productsList.innerHTML = '<p>Chưa có món ăn nào trong menu.</p>';
                return;
            }
            
            productsList.innerHTML = products.map((product, index) => {
                // Xử lý hiển thị giá theo loại
                let priceDisplay = '';
                if (product.category === 'nước') {
                    if (product.price && product.price.M && product.price.L) {
                        priceDisplay = `M: ${product.price.M.price} ${product.price.M.currency} | L: ${product.price.L.price} ${product.price.L.currency}`;
                    } else {
                        priceDisplay = 'Giá: Chưa có thông tin';
                    }
                } else {
                    if (product.price && typeof product.price === 'object' && product.price.price !== undefined) {
                        priceDisplay = `Giá: ${product.price.price} ${product.price.currency}`;
                    } else if (typeof product.price === 'number') {
                        // Dữ liệu cũ - giá trị price là số
                        priceDisplay = `Giá: ${product.price} ${product.currency || '€'}`;
                    } else {
                        priceDisplay = 'Giá: Chưa có thông tin';
                    }
                }
                
                return `
                    <div class="product-card">
                        ${product.image ? 
                            `<img src="${product.image}" class="product-image" alt="${product.name.vi}" onerror="this.onerror=null;this.parentElement.innerHTML='<div style=\\'height:200px;background:#ddd;display:flex;align-items:center;justify-content:center;border-radius:5px;margin-bottom:10px;color:#000;\\'>Không có hình ảnh</div>';">` : 
                            '<div style="height:200px;background:#ddd;display:flex;align-items:center;justify-content:center;border-radius:5px;margin-bottom:10px;color:#000;">Không có hình ảnh</div>'}
                        <div class="language-names">
                            <div class="language-name">VN: ${product.name.vi}</div>
                            <div class="language-name">EN: ${product.name.en || 'Chưa dịch'}</div>
                            <div class="language-name">FI: ${product.name.fi || 'Chưa dịch'}</div>
                        </div>
                        <div class="product-price">${priceDisplay}</div>
                        ${product.originalPrice ? `<div class="product-original-price">Giá gốc: ${product.originalPrice} ${product.currency}</div>` : ''}
                        <div class="product-category">Loại: ${product.category}</div>
                        <div class="product-ingredients">Thành phần VN: ${product.ingredients.vi}</div>
                        <div class="product-ingredients">Thành phần EN: ${product.ingredients.en || 'Chưa dịch'}</div>
                        <div class="product-ingredients">Thành phần FI: ${product.ingredients.fi || 'Chưa dịch'}</div>
                        <button class="edit-btn" onclick="editProduct('${product.id}')">Sửa</button>
                        <button class="delete-btn" onclick="deleteProduct('${product.id}')">Xóa</button>
                    </div>
                `;
            }).join('');
        }

        // Xóa sản phẩm
        async function deleteProduct(productId) {
            if (!checkAdminLogin()) {
                showNotification('Bạn cần đăng nhập với tài khoản admin!', 'error');
                setTimeout(() => showLoadingAndNavigate('login.html'), 2000);
                return;
            }

            showModal('Bạn có chắc chắn muốn xóa món ăn này?', async function() {
                try {
                    await deleteDoc(doc(db, "menu", productId));
                    await loadProductsFromFirestore();
                    displayProducts();
                    updateProductStats();
                    showNotification('Xóa món ăn thành công!', 'success');
                } catch (error) {
                    console.error('Lỗi khi xóa món ăn:', error);
                    showNotification('Lỗi khi xóa món ăn: ' + error.message, 'error');
                }
            });
        }

        // Sửa sản phẩm
        async function editProduct(productId) {
            if (!checkAdminLogin()) {
                showNotification('Bạn cần đăng nhập với tài khoản admin!', 'error');
                setTimeout(() => showLoadingAndNavigate('login.html'), 2000);
                return;
            }

            const product = menuData.find(p => p.id === productId);
            if (!product) {
                showNotification('Không tìm thấy món ăn!', 'error');
                return;
            }
            
            document.getElementById('name-vi').value = product.name.vi || '';
            document.getElementById('name-en').value = product.name.en || '';
            document.getElementById('name-fi').value = product.name.fi || '';
            document.getElementById('category').value = product.category || '';
            document.getElementById('ingredients-vi').value = product.ingredients.vi || '';
            document.getElementById('ingredients-en').value = product.ingredients.en || '';
            document.getElementById('ingredients-fi').value = product.ingredients.fi || '';
            
            // Xử lý hiển thị giá theo loại
            if (product.category === 'nước') {
                document.getElementById('priceGroup').style.display = 'none';
                document.getElementById('drinkPriceGroup').style.display = 'block';
                // Kiểm tra cấu trúc dữ liệu cũ hoặc mới
                if (product.price && product.price.M && product.price.L) {
                    document.getElementById('priceM').value = product.price.M.price || '';
                    document.getElementById('priceL').value = product.price.L.price || '';
                    document.getElementById('currencyM').value = product.price.M.currency || '€';
                    document.getElementById('currencyL').value = product.price.L.currency || '€';
                } else {
                    // Dữ liệu cũ - giá trị price là số
                    document.getElementById('priceM').value = '';
                    document.getElementById('priceL').value = '';
                    document.getElementById('currencyM').value = '€';
                    document.getElementById('currencyL').value = '€';
                }
            } else {
                document.getElementById('priceGroup').style.display = 'block';
                document.getElementById('drinkPriceGroup').style.display = 'none';
                // Kiểm tra cấu trúc dữ liệu cũ hoặc mới
                if (product.price && typeof product.price === 'object' && product.price.price !== undefined) {
                    document.getElementById('price').value = product.price.price || '';
                    document.getElementById('currency').value = product.price.currency || '€';
                } else if (typeof product.price === 'number') {
                    // Dữ liệu cũ - giá trị price là số
                    document.getElementById('price').value = product.price || '';
                    document.getElementById('currency').value = product.currency || '€';
                } else {
                    document.getElementById('price').value = '';
                    document.getElementById('currency').value = '€';
                }
            }
            
            // ===== HIỂN THỊ GIÁ GỐC NẾU LÀ LOUNAS =====
            if (product.category === 'lounas') {
                originalPriceGroup.style.display = 'block';
                originalPriceInput.value = product.originalPrice || '';
            } else {
                originalPriceGroup.style.display = 'none';
                originalPriceInput.value = '';
            }
            // ===== KẾT THÚC XỬ LÝ GIÁ GỐC =====
            
            // Reset file input và giữ ảnh cũ
            document.getElementById('image').value = '';
            currentImageBase64 = product.image; // Giữ ảnh base64 cũ
            if (product.image) {
                showNotification('Ảnh hiện tại sẽ được giữ nếu không chọn ảnh mới', 'info');
            }
            
            currentEditingProductId = productId;

            const submitBtn = document.querySelector('#productForm button[type="submit"]');
            submitBtn.textContent = 'Cập nhật Món Ăn';
            
            // Cập nhật required fields khi sửa
            updateRequiredFields();
            
            showNotification('Đang chỉnh sửa món ăn...', 'info');
            window.scrollTo(0, document.getElementById('productForm').offsetTop);
        }

        // Cập nhật sản phẩm
        async function updateProduct(productId) {
            if (!checkAdminLogin()) {
                showNotification('Bạn cần đăng nhập với tài khoản admin!', 'error');
                setTimeout(() => showLoadingAndNavigate('login.html'), 2000);
                return;
            }

            const nameVi = document.getElementById('name-vi').value;
            const nameEn = document.getElementById('name-en').value;
            const nameFi = document.getElementById('name-fi').value;
            const category = document.getElementById('category').value;
            const ingredientsVi = document.getElementById('ingredients-vi').value;
            const ingredientsEn = document.getElementById('ingredients-en').value;
            const ingredientsFi = document.getElementById('ingredients-fi').value;
            
            // Xử lý giá theo loại
            let priceData = {};
            if (category === 'nước') {
                const priceM = parseFloat(document.getElementById('priceM').value);
                const priceL = parseFloat(document.getElementById('priceL').value);
                const currencyM = document.getElementById('currencyM').value;
                const currencyL = document.getElementById('currencyL').value;
                
                if (!priceM || !priceL) {
                    showNotification('Vui lòng nhập đầy đủ giá cho size M và L!', 'warning');
                    return;
                }

                priceData = {
                    M: { price: priceM, currency: currencyM },
                    L: { price: priceL, currency: currencyL }
                };
            } else {
                const price = parseFloat(document.getElementById('price').value);
                const currency = document.getElementById('currency').value;
                
                if (!price || !currency) {
                    showNotification('Vui lòng nhập đầy đủ thông tin!', 'warning');
                    return;
                }

                priceData = { price, currency };
            }
            
            // ===== XỬ LÝ GIÁ GỐC =====
            let originalPrice = null;
            if (category === 'lounas') {
                const originalPriceValue = document.getElementById('originalPrice').value;
                if (originalPriceValue && parseFloat(originalPriceValue) > (priceData.price || priceData.M.price)) {
                    originalPrice = parseFloat(originalPriceValue);
                }
            }
            // ===== KẾT THÚC XỬ LÝ GIÁ GỐC =====
            
            // Sử dụng ảnh base64 mới nếu có, giữ ảnh cũ nếu không có
            let imageBase64 = menuData.find(p => p.id === productId)?.image || null; // Giữ ảnh cũ
            if (currentImageBase64 && currentImageBase64 !== imageBase64) {
                imageBase64 = currentImageBase64; // Dùng ảnh mới
                showNotification('Đã cập nhật ảnh mới!', 'success');
            }
            
            const updatedProduct = {
                name: { vi: nameVi, en: nameEn, fi: nameFi },
                price: priceData,
                category: category,
                ingredients: { vi: ingredientsVi, en: ingredientsEn, fi: ingredientsFi },
                image: imageBase64,
                originalPrice: originalPrice,
                updatedAt: new Date()
            };
            
            try {
                await updateDoc(doc(db, "menu", productId), updatedProduct);
                
                showNotification('Cập nhật món ăn thành công!', 'success');
                document.getElementById('productForm').reset();
                
                const submitBtn = document.querySelector('#productForm button[type="submit"]');
                submitBtn.textContent = 'Thêm Món Ăn';
                currentEditingProductId = null;
                currentImageBase64 = null;
                
                await loadProductsFromFirestore();
                displayProducts();
                updateProductStats();
            } catch (error) {
                console.error('Lỗi khi cập nhật món ăn:', error);
                showNotification('Lỗi khi cập nhật món ăn: ' + error.message, 'error');
            }
        }

        // Thêm sản phẩm mới
        async function addNewProduct() {
            if (!checkAdminLogin()) {
                showNotification('Bạn cần đăng nhập với tài khoản admin!', 'error');
                setTimeout(() => showLoadingAndNavigate('login.html'), 2000);
                return;
            }

            const nameVi = document.getElementById('name-vi').value;
            const nameEn = document.getElementById('name-en').value;
            const nameFi = document.getElementById('name-fi').value;
            const category = document.getElementById('category').value;
            const ingredientsVi = document.getElementById('ingredients-vi').value;
            const ingredientsEn = document.getElementById('ingredients-en').value;
            const ingredientsFi = document.getElementById('ingredients-fi').value;
            
            if (!nameVi || !nameEn || !nameFi || !category || 
                !ingredientsVi || !ingredientsEn || !ingredientsFi) {
                showNotification('Vui lòng nhập đầy đủ thông tin!', 'warning');
                return;
            }
            
            // Xử lý giá theo loại
            let priceData = {};
            if (category === 'nước') {
                const priceM = parseFloat(document.getElementById('priceM').value);
                const priceL = parseFloat(document.getElementById('priceL').value);
                const currencyM = document.getElementById('currencyM').value;
                const currencyL = document.getElementById('currencyL').value;
                
                if (!priceM || !priceL) {
                    showNotification('Vui lòng nhập đầy đủ giá cho size M và L!', 'warning');
                    return;
                }

                priceData = {
                    M: { price: priceM, currency: currencyM },
                    L: { price: priceL, currency: currencyL }
                };
            } else {
                const price = parseFloat(document.getElementById('price').value);
                const currency = document.getElementById('currency').value;
                
                if (!price || !currency) {
                    showNotification('Vui lòng nhập đầy đủ thông tin!', 'warning');
                    return;
                }

                priceData = { price, currency };
            }
            
            // ===== XỬ LÝ GIÁ GỐC =====
            let originalPrice = null;
            if (category === 'lounas') {
                const originalPriceValue = document.getElementById('originalPrice').value;
                if (originalPriceValue && parseFloat(originalPriceValue) > priceData.price) {
                    originalPrice = parseFloat(originalPriceValue);
                }
            }
            // ===== KẾT THÚC XỬ LÝ GIÁ GỐC =====
            
            const newProduct = {
                name: { vi: nameVi, en: nameEn, fi: nameFi },
                price: priceData,
                category: category,
                ingredients: { vi: ingredientsVi, en: ingredientsEn, fi: ingredientsFi },
                image: currentImageBase64, // Lưu ảnh base64
                originalPrice: originalPrice,
                createdAt: new Date()
            };
            
            try {
                await addDoc(collection(db, "menu"), newProduct);
                document.getElementById('productForm').reset();
                currentImageBase64 = null;
                showNotification('Thêm món ăn thành công!', 'success');
                
                await loadProductsFromFirestore();
                displayProducts();
                updateProductStats();
            } catch (error) {
                console.error('Lỗi khi thêm món ăn:', error);
                showNotification('Lỗi khi thêm món ăn: ' + error.message, 'error');
            }
        }

        // Xử lý form thêm/sửa sản phẩm
        document.getElementById('productForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.remove('hidden');
            
            try {
                if (currentEditingProductId !== null) {
                    await updateProduct(currentEditingProductId);
                } else {
                    await addNewProduct();
                }
            } catch (error) {
                console.error('Lỗi khi xử lý form:', error);
                showNotification('Lỗi khi xử lý form: ' + error.message, 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        });

        // Tìm kiếm sản phẩm
        function searchProducts() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            if (searchTerm === '') {
                displayProducts();
                return;
            }
            
            const filteredProducts = menuData.filter(product => 
                (product.name.vi && product.name.vi.toLowerCase().includes(searchTerm)) ||
                (product.name.en && product.name.en.toLowerCase().includes(searchTerm)) ||
                (product.name.fi && product.name.fi.toLowerCase().includes(searchTerm)) ||
                (product.category && product.category.toLowerCase().includes(searchTerm)) ||
                (product.ingredients.vi && product.ingredients.vi.toLowerCase().includes(searchTerm)) ||
                (product.ingredients.en && product.ingredients.en.toLowerCase().includes(searchTerm)) ||
                (product.ingredients.fi && product.ingredients.fi.toLowerCase().includes(searchTerm))
            );
            
            displayProducts(filteredProducts);
        }

        // Lọc sản phẩm theo loại
        function filterProducts() {
            const categoryFilter = document.getElementById('category-filter').value;
            
            if (categoryFilter === '') {
                displayProducts();
                return;
            }
            
            const filteredProducts = menuData.filter(product => 
                product.category === categoryFilter
            );
            
            displayProducts(filteredProducts);
        }

        // Cập nhật thống kê sản phẩm
        function updateProductStats() {
            const totalProducts = menuData.length;
            const categories = [...new Set(menuData.map(product => product.category))];
            const totalCategories = categories.length;
            
            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('totalCategories').textContent = totalCategories;
        }

        // Tải danh sách sản phẩm
        async function loadProducts() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.remove('hidden');
            
            try {
                await loadProductsFromFirestore();
                displayProducts();
                updateProductStats();
                showNotification('Đã làm mới danh sách sản phẩm!', 'info');
            } catch (error) {
                console.error('Lỗi khi load sản phẩm:', error);
                showNotification('Lỗi khi load sản phẩm: ' + error.message, 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        // Xuất menu (tải file xuống)
        function exportMenu() {
            try {
                const jsonData = JSON.stringify(menuData, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'menu.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('Menu đã được xuất thành công!', 'success');
            } catch (error) {
                showNotification('Lỗi khi xuất menu: ' + error.message, 'error');
            }
        }

        // Nhập menu từ file và lưu vào Firestore
        function importMenu() {
            try {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                
                input.onchange = async function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = async function(event) {
                        try {
                            const jsonData = event.target.result;
                            const products = JSON.parse(jsonData);
                            
                            // Xóa tất cả dữ liệu cũ trong Firestore
                            const querySnapshot = await getDocs(collection(db, "menu"));
                            const deletePromises = [];
                            querySnapshot.forEach((doc) => {
                                deletePromises.push(deleteDoc(doc.ref));
                            });
                            await Promise.all(deletePromises);
                            
                            // Thêm dữ liệu mới vào Firestore
                            const addPromises = [];
                            products.forEach((product) => {
                                // Đảm bảo dữ liệu có định dạng đúng
                                let priceData = product.price;
                                if (product.category === 'nước') {
                                    // Nếu là nước nhưng chưa có cấu trúc M/L, tạo mặc định
                                    if (!priceData || !priceData.M || !priceData.L) {
                                        priceData = {
                                            M: { price: 0, currency: '€' },
                                            L: { price: 0, currency: '€' }
                                        };
                                    }
                                } else {
                                    // Nếu không phải nước nhưng có cấu trúc M/L, chuyển về dạng đơn
                                    if (priceData && (priceData.M || priceData.L)) {
                                        priceData = { price: priceData.M?.price || 0, currency: priceData.M?.currency || '€' };
                                    } else if (typeof priceData !== 'object' || priceData.price === undefined) {
                                        // Dữ liệu cũ - giá trị price là số
                                        priceData = { price: priceData || 0, currency: product.currency || '€' };
                                    }
                                }
                                
                                const productData = {
                                    name: product.name || { vi: '', en: '', fi: '' },
                                    price: priceData,
                                    category: product.category || '',
                                    ingredients: product.ingredients || { vi: '', en: '', fi: '' },
                                    image: product.image || null,
                                    originalPrice: product.originalPrice || null,
                                    createdAt: new Date()
                                };
                                addPromises.push(addDoc(collection(db, "menu"), productData));
                            });
                            await Promise.all(addPromises);
                            
                            // Reload dữ liệu
                            await loadProductsFromFirestore();
                            displayProducts();
                            updateProductStats();
                            
                            showNotification('Menu đã được nhập và lưu thành công!', 'success');
                        } catch (error) {
                            showNotification('Lỗi khi nhập menu: File không hợp lệ', 'error');
                        }
                    };
                    
                    reader.readAsText(file);
                };
                
                input.click();
            } catch (error) {
                showNotification('Lỗi khi nhập menu: ' + error.message, 'error');
            }
        }

        // Tải danh sách users và sản phẩm khi trang load
        window.addEventListener('load', async function () {
            // Lấy API key khi khởi động
            GOOGLE_TRANSLATE_API_KEY = await getApiKeyFromFirestore();
            console.log("Đã tải API key từ Firestore");

            // Tải danh mục từ Firestore
            await loadCategoriesFromFirestore();

            // Tải menu từ Firestore
            await loadProductsFromFirestore();
            
            await loadUsers();
            displayProducts();
            updateProductStats();
            
            translateDishNameOnEnter();
            translateIngredientsOnEnter();
            
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                setTimeout(() => {
                    loadingOverlay.classList.add('hidden');
                    if (checkAdminLogin()) {
                        showNotification('Chào mừng đến trang quản trị!', 'info');
                    }
                }, 500);
            }
            
            // Khởi tạo required fields
            updateRequiredFields();
        });

        // GÁN CÁC HÀM RA GLOBAL ĐỂ HTML CÓ THỂ GỌI ĐƯỢC
        window.logout = logout;
        window.showTab = showTab;
        window.closeNotification = closeNotification;
        window.showAddCategoryModal = showAddCategoryModal;
        window.deleteUser = deleteUser;
        window.searchProducts = searchProducts;
        window.filterProducts = filterProducts;
        window.loadProducts = loadProducts;
        window.exportMenu = exportMenu;
        window.importMenu = importMenu;
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;
    </script>
</body>
</html>