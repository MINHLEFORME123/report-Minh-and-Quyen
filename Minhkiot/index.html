
<!DOCTYPE html>
<html>
  <head>
    <link rel="icon" type="image/png" href="logo.png">
    <title>Minhkiot - Đăng nhập</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="stylesheet" href="login.css">
  </head>
  <body>
    <div class="login-container"> 
        <h1>Đăng nhập hệ thống</h1>
        <form id="loginForm">
          <div class="inputinf">
            <label for="username">Tên đăng nhập:</label>
            <input type="text" id="username" name="username" required>
          </div>
          <div class="inputinf">
            <label for="password">Mật khẩu:</label>
            <input type="password" id="password" name="password" required>
          </div>
          <button type="submit">Đăng Nhập</button>
        </form>
        <div id="message"></div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
      // Import Firebase functions
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
      import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyCh1zPuWrZ6g3UHQPJeahp--96vHoiRB-k",
        authDomain: "minhkiot-7f5d6.firebaseapp.com",
        projectId: "minhkiot-7f5d6",
        storageBucket: "minhkiot-7f5d6.firebasestorage.app",
        messagingSenderId: "25045319035",
        appId: "1:25045319035:web:30e7e5d07dc3a75c8411de",
        measurementId: "G-FZHVBC1NFG"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // Hiển thị loading
      function showLoading() {
        const messageDiv = document.getElementById('message');
        messageDiv.innerHTML = '<p>Đang kiểm tra thông tin đăng nhập...</p>';
      }

      // Ẩn loading
      function hideLoading() {
        const messageDiv = document.getElementById('message');
        messageDiv.innerHTML = '';
      }

      // Lấy danh sách người dùng từ Firebase
      async function getUsersFromFirebase() {
        try {
          const querySnapshot = await getDocs(collection(db, "users"));
          const userLines = [];
          
          querySnapshot.forEach((doc) => {
            const userData = doc.data();
            // Định dạng giống file txt: username:password:role
            userLines.push(`${userData.username}:${userData.password}:${userData.role}`);
          });
          
          return userLines;
        } catch (error) {
          console.error('Lỗi khi lấy dữ liệu từ Firebase:', error);
          throw new Error('Không thể tải dữ liệu người dùng từ Firebase');
        }
      }

      // Xác thực người dùng
      function authenticateUser(username, password, userLines, messageDiv) {
        let authenticated = false;
        let userRole = 'customer'; // Mặc định là customer

        for (let line of userLines) {
          line = line.trim();
          if (line) {
            const parts = line.split(':');
            const user = parts[0];
            const pass = parts[1];
            const role = parts[2] || 'customer'; // Nếu không có role thì mặc định customer

            if (username === user && password === pass) {
              authenticated = true;
              userRole = role;
              break;
            }
          }
        }

        if (authenticated) {
          messageDiv.innerHTML = '<p style="color: green;">Đăng nhập thành công!</p>';
          localStorage.setItem('loggedInUser', username);

          setTimeout(() => {
            switch(userRole) {
              case 'admin':
                window.location.href = './admin.html';
                break;
              case 'manager':
                window.location.href = './manager.html';
                break;
              case 'cashier':
                window.location.href = './cashier.html';
                break;
              case 'customer':
                window.location.href = './customer.html';
                break;
              default:
                window.location.href = './dashboard.html';
            }
          }, 1000);
        } else {
          messageDiv.innerHTML = '<p style="color: red;">Tên đăng nhập hoặc mật khẩu không đúng!</p>';
        }
      }

      // Xử lý form đăng nhập
      document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const messageDiv = document.getElementById('message');

        try {
          showLoading();
          // Lấy dữ liệu người dùng từ Firebase
          const userLines = await getUsersFromFirebase();
          authenticateUser(username, password, userLines, messageDiv);
        } catch (error) {
          hideLoading();
          messageDiv.innerHTML = `<p style="color: red;">${error.message}</p>`;
        }
      });
    </script>
  </body>
</html>